name: Release

on:
  workflow_dispatch:
    inputs:
      release-version:
        description: 'Release version (e.g., 2.4.0)'
        required: true
        type: string
      next-snapshot-version:
        description: 'Next SNAPSHOT version (e.g., 2.5.0-SNAPSHOT)'
        required: true
        type: string
      skip-tests:
        description: 'Skip tests (use only for emergency releases)'
        required: false
        type: boolean
        default: false
      skip-owasp-check:
        description: 'Skip OWASP dependency check'
        required: false
        type: boolean
        default: false
      delete-release-branch-on-failure:
        description: 'Delete release branch if workflow fails'
        required: false
        type: boolean
        default: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.ACTIONS_KEY }}
        fetch-depth: 0  # Full history for release notes generation

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'adopt'
        cache: maven
        server-id: github
        server-username: GITHUB_ACTOR
        server-password: GITHUB_TOKEN

    - name: Set up Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.0

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Validate prerequisites
      id: validate
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Validating release prerequisites..."

        # Validate version formats
        if [[ ! "${{ inputs.release-version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Release version must be in format X.Y.Z (e.g., 2.4.0)"
          exit 1
        fi
        if [[ ! "${{ inputs.next-snapshot-version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+\-SNAPSHOT$ ]]; then
          echo "Error: Next SNAPSHOT version must be in format X.Y.Z-SNAPSHOT (e.g., 2.5.0-SNAPSHOT)"
          exit 1
        fi
        echo "Version format validation passed"

        # Validate current branch is develop
        CURRENT_BRANCH="${{ github.ref_name }}"
        if [[ "$CURRENT_BRANCH" != "develop" ]]; then
          echo "Error: Release workflow must be run from 'develop' branch"
          echo "Current branch: $CURRENT_BRANCH"
          echo ""
          echo "Please switch to develop branch and try again:"
          echo "  git checkout develop"
          echo "  git pull origin develop"
          exit 1
        fi
        echo "Running from develop branch"

        # Set release branch name
        RELEASE_BRANCH="release/${{ inputs.release-version }}"
        echo "release_branch=$RELEASE_BRANCH" >> $GITHUB_OUTPUT
        echo "Release branch will be: $RELEASE_BRANCH"

        # Check if release branch already exists
        if git ls-remote --exit-code --heads origin "$RELEASE_BRANCH" >/dev/null 2>&1; then
          echo "Error: Release branch '$RELEASE_BRANCH' already exists"
          echo ""
          echo "This likely means a previous release attempt failed or is in progress."
          echo "Please either:"
          echo "  1. Delete the branch: git push origin --delete $RELEASE_BRANCH"
          echo "  2. Or use a different version number"
          exit 1
        fi
        echo "Release branch does not exist yet"

        # Check if tag already exists
        if git ls-remote --exit-code --tags origin "v${{ inputs.release-version }}" >/dev/null 2>&1; then
          echo "Error: Tag 'v${{ inputs.release-version }}' already exists"
          echo "This version has already been released. Please use a different version number."
          exit 1
        fi
        echo "Release tag does not exist yet"

        # Check if artifact already exists in GitHub Packages
        echo "Checking if artifact already exists in GitHub Packages..."

        # Try to check if the package version exists using GitHub API
        # Note: This checks for the package version, not individual artifacts
        PACKAGE_EXISTS=$(gh api \
          -H "Accept: application/vnd.github+json" \
          "/orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions" \
          --jq ".[] | select(.name==\"${{ inputs.release-version }}\") | .name" 2>/dev/null || echo "")

        if [ -n "$PACKAGE_EXISTS" ]; then
          echo "ERROR: Artifact version ${{ inputs.release-version }} already exists in GitHub Packages"
          echo ""
          echo "This likely means a previous release attempt failed after deploying artifacts."
          echo ""
          echo "To clean up and retry the release:"
          echo ""
          echo "1. Delete the package version from GitHub Packages:"
          echo "   - Via GitHub CLI:"
          echo "     VERSION_ID=\$(gh api /orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions --jq '.[] | select(.name==\"${{ inputs.release-version }}\") | .id')"
          echo "     gh api --method DELETE /orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions/\$VERSION_ID"
          echo ""
          echo "   - Via GitHub UI:"
          echo "     https://github.com/orgs/IZGateway/packages?repo_name=izgw-core"
          echo "     Select 'izgw-core' package, find version ${{ inputs.release-version }}, and delete"
          echo ""
          echo "2. Delete the release branch if it was created:"
          echo "   git push origin --delete release/${{ inputs.release-version }}"
          echo ""
          echo "3. Delete the git tag if it was created:"
          echo "   git push origin --delete v${{ inputs.release-version }}"
          echo ""
          echo "4. If merge to main happened, you may need to revert the merge commit on main"
          echo ""
          echo "5. After cleanup, re-run this workflow"
          exit 1
        fi

        echo "Artifact does not exist in GitHub Packages yet"

    - name: Check for SNAPSHOT dependencies
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Checking for SNAPSHOT dependencies..."

        # Check regular dependencies
        # Get the current version of this project from the pom.xml, we want to filter this out of the dependency:list check
        POM_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        SNAPSHOT_DEPS=$(mvn dependency:list | grep -v $POM_VERSION | grep SNAPSHOT || true)

        # Check parent POM version separately (not included in dependency:list)
        PARENT_VERSION=$(mvn help:evaluate -Dexpression=project.parent.version -q -DforceStdout)
        if [[ "$PARENT_VERSION" == *"SNAPSHOT"* ]]; then
          echo "ERROR: Parent POM is a SNAPSHOT version: $PARENT_VERSION"
          echo ""
          echo "Please release izgw-bom first before releasing izgw-core."
          exit 1
        fi
        echo "Parent POM version is a release version: $PARENT_VERSION"

        # Check if any regular dependencies are SNAPSHOT
        if [ -n "$SNAPSHOT_DEPS" ]; then
          echo "ERROR: Found SNAPSHOT dependencies in the project:"
          echo "$SNAPSHOT_DEPS"
          echo ""
          echo "Please update all dependencies to release versions before creating a release."
          exit 1
        fi

        echo "No SNAPSHOT dependencies found - ready for release"

    - name: Run tests
      if: ${{ !inputs.skip-tests }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COMMON_PASS: ${{ secrets.COMMON_PASS }}
        ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
      run: |
        echo "Running test suite..."
        mvn -B clean test

    - name: Run OWASP Dependency Check
      if: ${{ !inputs.skip-tests && !inputs.skip-owasp-check }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Running OWASP dependency check..."
        mvn -B org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=7

    - name: Upload dependency check report
      if: ${{ !inputs.skip-tests && !inputs.skip-owasp-check }}
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: ./target/dependency-check-report.*
        if-no-files-found: ignore

    - name: Create release branch
      run: |
        echo "Creating release branch: ${{ steps.validate.outputs.release_branch }}"
        git checkout -b "${{ steps.validate.outputs.release_branch }}"
        git push origin "${{ steps.validate.outputs.release_branch }}"
        echo "Release branch created and pushed"

    - name: Generate release notes from PRs
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Generating release note entries from merged PRs..."

        # Get the previous tag (most recent tag by version, not by ancestry)
        # This works even when develop branch doesn't have tags in its commit history
        PREVIOUS_TAG=$(git tag -l "v*" --sort=-v:refname | head -n 1)

        if [ -z "$PREVIOUS_TAG" ]; then
          echo "First release, getting all merge commits"
          # Get all merge commits
          PR_CHANGES=$(git log --merges --oneline | grep "pull request" | sed -E 's/.*#([0-9]+).*/\1/' | xargs -I {} gh pr view {} --json number,title,url --jq '"- \(.title) ([#\(.number)](\(.url)))"')
        else
          echo "Generating release note from $PREVIOUS_TAG to HEAD"
          # Get merge commits since the previous tag
          PR_CHANGES=$(git log ${PREVIOUS_TAG}..HEAD --merges --oneline | grep "pull request" | sed -E 's/.*#([0-9]+).*/\1/' | xargs -I {} gh pr view {} --json number,title,url --jq '"- \(.title) ([#\(.number)](\(.url)))"')
        fi

        # Check if we found any PRs
        if [ -z "$PR_CHANGES" ]; then
          echo "WARNING: No merged PRs found. Using commit messages as fallback."
          if [ -z "$PREVIOUS_TAG" ]; then
            PR_CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            PR_CHANGES=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
        fi

        # Save PR changes to file for reuse in both RELEASE_NOTES.md and GitHub Release
        echo "$PR_CHANGES" > PR_CHANGES.txt
        echo "Release notes generated and saved to PR_CHANGES.txt"

    - name: Update RELEASE_NOTES.md
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Updating RELEASE_NOTES.md with generated release notes..."

        # Read pre-generated PR changes
        PR_CHANGES=$(cat PR_CHANGES.txt)

        # Get current date
        RELEASE_DATE=$(date +%Y-%m-%d)

        # Create new release note entry
        cat > RELEASE_NOTES_ENTRY.md << EOF
        ## [${{ inputs.release-version }}] - $RELEASE_DATE

        ### Changes
        $PR_CHANGES

        EOF

        # Check if RELEASE_NOTES.md exists
        if [ -f "RELEASE_NOTES.md" ]; then
          # Prepend new entry to existing RELEASE_NOTES.md
          cat RELEASE_NOTES.md >> RELEASE_NOTES_ENTRY.md
          mv RELEASE_NOTES_ENTRY.md RELEASE_NOTES.md
        else
          # Create new RELEASE_NOTES.md
          cat > RELEASE_NOTES.md << EOF
        # Release Notes

        All notable changes to this project will be documented in this file.

        The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
        and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

        EOF
          cat RELEASE_NOTES_ENTRY.md >> RELEASE_NOTES.md
          rm RELEASE_NOTES_ENTRY.md
        fi

        git add RELEASE_NOTES.md
        git commit -m "docs: update RELEASE_NOTES.md for release ${{ inputs.release-version }}"
        echo "RELEASE_NOTES.md updated"

    - name: Set release version
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Setting version to ${{ inputs.release-version }}"
        mvn versions:set -DnewVersion=${{ inputs.release-version }} -DgenerateBackupPoms=false
        git add pom.xml
        git commit -m "chore: prepare release ${{ inputs.release-version }}"
        git push origin "${{ steps.validate.outputs.release_branch }}"
        echo "Release version set and committed"

    - name: Build and package
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COMMON_PASS: ${{ secrets.COMMON_PASS }}
        ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
      run: |
        echo "Building release artifacts..."
        mvn -B clean package -DskipTests=${{ inputs.skip-tests }} -DskipDependencyCheck=true

    - name: Merge release branch to main
      run: |
        echo "Merging release branch to main..."

        # Check if main branch exists
        if git ls-remote --exit-code --heads origin main >/dev/null 2>&1; then
          echo "Main branch exists, fetching..."
          git fetch origin main
          git checkout main
          # Use -X theirs to prefer release branch version for conflicts (e.g., RELEASE_NOTES.md)
          # During a release, the release branch has the authoritative version of release documentation
          git merge --no-ff -X theirs "${{ steps.validate.outputs.release_branch }}" -m "Merge release branch ${{ steps.validate.outputs.release_branch }}"
        else
          echo "Main branch does not exist (first release), creating from release branch..."
          git checkout -b main
        fi

        git push origin main
        echo "Release branch merged to main"

    - name: Create Git tag on main
      run: |
        echo "Creating tag v${{ inputs.release-version }} on main branch..."
        git tag -a "v${{ inputs.release-version }}" -m "Release version ${{ inputs.release-version }}"
        git push origin "v${{ inputs.release-version }}"
        echo "Tag created on main"

    - name: Deploy to GitHub Packages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COMMON_PASS: ${{ secrets.COMMON_PASS }}
      run: |
        echo "Deploying to GitHub Packages..."
        echo "Git operations completed successfully - proceeding with artifact deployment"
        mvn -B deploy -DskipTests -DskipDependencyCheck=true
        echo "Artifacts deployed to GitHub Packages"

    - name: Generate GitHub Release body
      id: release-notes
      run: |
        echo "Creating GitHub Release body from pre-generated release notes..."

        # Read pre-generated PR changes
        PR_CHANGES=$(cat PR_CHANGES.txt)

        # Save release notes to file for GitHub Release
        cat << EOF > GITHUB_RELEASE_BODY.md
        # Release ${{ inputs.release-version }}

        ## Changes

        $PR_CHANGES

        ## Installation

        Add to your \`pom.xml\`:

        \`\`\`xml
        <dependency>
          <groupId>gov.cdc.izgw</groupId>
          <artifactId>izgw-core</artifactId>
          <version>${{ inputs.release-version }}</version>
        </dependency>
        \`\`\`

        ## Maven Repository

        \`\`\`xml
        <repositories>
          <repository>
            <id>github</id>
            <url>https://maven.pkg.github.com/IZGateway/izgw-core</url>
          </repository>
        </repositories>
        \`\`\`
        EOF
        echo "GitHub Release body created"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ inputs.release-version }}
        name: IZ Gateway Core v${{ inputs.release-version }}
        body_path: GITHUB_RELEASE_BODY.md
        draft: false
        prerelease: false
        generate_release_notes: false
        files: |
          target/*.jar
          target/*.pom
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update develop branch
      run: |
        echo "Updating develop branch..."

        # Discard all local changes from main branch (RELEASE_NOTES.md, etc.)
        echo "Discarding local changes to prepare for develop checkout..."
        git reset --hard HEAD
        git clean -fd

        # Fetch latest develop and checkout
        git fetch origin develop
        git checkout develop
        git reset --hard origin/develop

        # Merge release branch to get RELEASE_NOTES.md updates
        echo "Merging release branch to develop for RELEASE_NOTES updates..."
        git merge --no-ff "${{ steps.validate.outputs.release_branch }}" -m "Merge release branch ${{ steps.validate.outputs.release_branch }} to develop"

        # Bump to next SNAPSHOT version
        echo "Bumping to next SNAPSHOT version: ${{ inputs.next-snapshot-version }}"
        mvn versions:set -DnewVersion=${{ inputs.next-snapshot-version }} -DgenerateBackupPoms=false
        git add pom.xml
        git commit -m "chore: bump version to ${{ inputs.next-snapshot-version }}"

        # Push develop
        git push origin develop
        echo "Develop branch updated with RELEASE_NOTES and next SNAPSHOT version"

    - name: Summary
      run: |
        echo "## Release Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Release Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Release version:** ${{ inputs.release-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release branch:** ${{ steps.validate.outputs.release_branch }} (kept)" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag:** v${{ inputs.release-version }} (on main)" >> $GITHUB_STEP_SUMMARY
        echo "- **Next version:** ${{ inputs.next-snapshot-version }} (on develop)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### What Happened" >> $GITHUB_STEP_SUMMARY
        if [ "${{ inputs.skip-tests }}" == "true" ]; then
          echo "1. Skipped tests (emergency release mode)" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ inputs.skip-owasp-check }}" == "true" ]; then
          echo "1. Ran tests on develop branch (OWASP check skipped)" >> $GITHUB_STEP_SUMMARY
        else
          echo "1. Ran tests and OWASP security check on develop branch" >> $GITHUB_STEP_SUMMARY
        fi
        echo "2. Created release branch from develop" >> $GITHUB_STEP_SUMMARY
        echo "3. Updated RELEASE_NOTES.md with release notes" >> $GITHUB_STEP_SUMMARY
        echo "4. Set version to ${{ inputs.release-version }}" >> $GITHUB_STEP_SUMMARY
        echo "5. Built release artifacts" >> $GITHUB_STEP_SUMMARY
        echo "6. Merged release branch to main (auto-resolving conflicts)" >> $GITHUB_STEP_SUMMARY
        echo "7. Tagged v${{ inputs.release-version }} on main" >> $GITHUB_STEP_SUMMARY
        echo "8. Deployed artifacts to GitHub Packages" >> $GITHUB_STEP_SUMMARY
        echo "9. Created GitHub Release" >> $GITHUB_STEP_SUMMARY
        echo "10. Updated develop with RELEASE_NOTES and bumped to ${{ inputs.next-snapshot-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.release-version }})" >> $GITHUB_STEP_SUMMARY
        echo "2. **Notify consuming applications (izg-hub, izg-xform) of the new release**" >> $GITHUB_STEP_SUMMARY
        echo "3. Review RELEASE_NOTES.md in develop branch" >> $GITHUB_STEP_SUMMARY
        echo "4. Update integration documentation if needed" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup on failure
      if: failure() && inputs.delete-release-branch-on-failure
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Cleaning up failed release..."

        # Delete git tag if it exists
        if git ls-remote --exit-code --tags origin "v${{ inputs.release-version }}" >/dev/null 2>&1; then
          echo "Deleting git tag: v${{ inputs.release-version }}"
          git push origin --delete "v${{ inputs.release-version }}" || true
        fi

        # Revert merge to main if it happened
        if git ls-remote --exit-code --heads origin main >/dev/null 2>&1; then
          echo "Checking if merge to main needs to be reverted..."
          git fetch origin main
          git checkout main

          # Check if the last commit is a merge from our release branch
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$LAST_COMMIT_MSG" == *"Merge release branch ${{ steps.validate.outputs.release_branch }}"* ]]; then
            echo "Reverting merge commit on main..."
            git reset --hard HEAD~1
            git push origin main --force || echo "WARNING: Failed to revert main - manual cleanup may be required"
          else
            echo "No merge commit found on main (or other commits after it) - skipping revert"
          fi
        fi

        # Delete release branch if it exists
        if git ls-remote --exit-code --heads origin "${{ steps.validate.outputs.release_branch }}" >/dev/null 2>&1; then
          echo "Deleting release branch: ${{ steps.validate.outputs.release_branch }}"
          git push origin --delete "${{ steps.validate.outputs.release_branch }}" || true
        fi

        # Try to delete artifact from GitHub Packages if it was deployed
        VERSION_ID=$(gh api \
          -H "Accept: application/vnd.github+json" \
          "/orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions" \
          --jq ".[] | select(.name==\"${{ inputs.release-version }}\") | .id" 2>/dev/null || echo "")

        if [ -n "$VERSION_ID" ]; then
          echo "Deleting artifact from GitHub Packages (version ID: $VERSION_ID)..."
          gh api --method DELETE "/orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions/$VERSION_ID" || true
        fi

        # Delete GitHub Release if it was created
        if gh release view "v${{ inputs.release-version }}" >/dev/null 2>&1; then
          echo "Deleting GitHub Release..."
          gh release delete "v${{ inputs.release-version }}" --yes || true
        fi

        echo "## Release Failed - Cleaned Up" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The release process failed. Attempted cleanup of:" >> $GITHUB_STEP_SUMMARY
        echo "- Git tag (if created)" >> $GITHUB_STEP_SUMMARY
        echo "- Main branch merge commit (if created)" >> $GITHUB_STEP_SUMMARY
        echo "- Release branch (if created)" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub Packages artifact (if deployed)" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub Release (if created)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Troubleshooting" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the error logs above" >> $GITHUB_STEP_SUMMARY
        echo "2. Fix issues on develop branch" >> $GITHUB_STEP_SUMMARY
        echo "3. Run the workflow again" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Common Issues" >> $GITHUB_STEP_SUMMARY
        echo "- Tests failing: Fix tests on develop and re-run" >> $GITHUB_STEP_SUMMARY
        echo "- SNAPSHOT dependencies: Update dependencies to release versions" >> $GITHUB_STEP_SUMMARY
        echo "- Authentication issues: Verify GitHub Packages credentials" >> $GITHUB_STEP_SUMMARY
        echo "- Branch/tag conflicts: Check if release already exists" >> $GITHUB_STEP_SUMMARY

    - name: Notify on failure (keep branch)
      if: failure() && !inputs.delete-release-branch-on-failure
      run: |
        echo "## Release Failed - Branch Kept" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The release process failed. The release branch **${{ steps.validate.outputs.release_branch }}** has been kept for investigation." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Manual Cleanup Required" >> $GITHUB_STEP_SUMMARY
        echo "You may need to clean up the following (check if they exist):" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **Main branch merge** (if it happened):" >> $GITHUB_STEP_SUMMARY
        echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "   git checkout main" >> $GITHUB_STEP_SUMMARY
        echo "   git reset --hard HEAD~1  # Revert the merge commit" >> $GITHUB_STEP_SUMMARY
        echo "   git push origin main --force" >> $GITHUB_STEP_SUMMARY
        echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "2. **Git tag** (if created):" >> $GITHUB_STEP_SUMMARY
        echo "   \`git push origin --delete v${{ inputs.release-version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "3. **Release branch** (when ready):" >> $GITHUB_STEP_SUMMARY
        echo "   \`git push origin --delete ${{ steps.validate.outputs.release_branch }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "4. **GitHub Packages artifact** (if deployed):" >> $GITHUB_STEP_SUMMARY
        echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "   VERSION_ID=\\\$(gh api /orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions --jq '.[] | select(.name==\"${{ inputs.release-version }}\") | .id')" >> $GITHUB_STEP_SUMMARY
        echo "   gh api --method DELETE /orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions/\\\$VERSION_ID" >> $GITHUB_STEP_SUMMARY
        echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "5. **GitHub Release** (if created):" >> $GITHUB_STEP_SUMMARY
        echo "   \`gh release delete v${{ inputs.release-version }} --yes\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the error logs above" >> $GITHUB_STEP_SUMMARY
        echo "2. Investigate the release branch manually if needed" >> $GITHUB_STEP_SUMMARY
        echo "3. Clean up artifacts using commands above" >> $GITHUB_STEP_SUMMARY
        echo "4. Fix issues on develop branch" >> $GITHUB_STEP_SUMMARY
        echo "5. Run the workflow again" >> $GITHUB_STEP_SUMMARY
