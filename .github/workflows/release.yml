name: Release

on:
  workflow_dispatch:
    inputs:
      release-version:
        description: 'Release version (e.g., 2.3.0)'
        required: true
        type: string
      next-snapshot-version:
        description: 'Next SNAPSHOT version (e.g., 2.4.0-SNAPSHOT)'
        required: true
        type: string
      skip-tests:
        description: 'Skip tests (use only for emergency releases)'
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.ACTIONS_KEY }}
        fetch-depth: 0  # Full history for changelog generation

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'adopt'
        cache: maven

    - name: Set up Maven Settings
      run: |
        mkdir -p ~/.m2
        cat << EOF > ~/.m2/settings.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
          https://maven.apache.org/xsd/settings-1.0.0.xsd">
          <localRepository>~/.m2/repository</localRepository>
          <servers>
            <server>
              <id>github</id>
              <username>\${{ secrets.GH_USERNAME }}</username>
              <password>\${{ secrets.GH_PASSWORD }}</password>
            </server>
          </servers>
        </settings>
        EOF

    - name: Set up Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.0

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Validate release version format
      run: |
        if [[ ! "${{ inputs.release-version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Release version must be in format X.Y.Z (e.g., 2.3.0)"
          exit 1
        fi
        if [[ ! "${{ inputs.next-snapshot-version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+-SNAPSHOT$ ]]; then
          echo "Error: Next SNAPSHOT version must be in format X.Y.Z-SNAPSHOT (e.g., 2.4.0-SNAPSHOT)"
          exit 1
        fi

    - name: Get current version
      id: current-version
      run: |
        CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"

    - name: Check for SNAPSHOT dependencies
      run: |
        echo "Checking for SNAPSHOT dependencies..."
        # Get all SNAPSHOT dependencies except izgw-bom (parent)
        SNAPSHOT_DEPS=$(mvn dependency:list -DexcludeGroupIds=gov.cdc.izgw | grep SNAPSHOT || true)

        if [ -n "$SNAPSHOT_DEPS" ]; then
          echo "ERROR: Found SNAPSHOT dependencies in the project:"
          echo "$SNAPSHOT_DEPS"
          echo ""
          echo "Please update all dependencies to release versions before creating a release."
          exit 1
        else
          echo "✓ No SNAPSHOT dependencies found (parent BOM excluded)"
        fi

    - name: Run tests
      if: ${{ !inputs.skip-tests }}
      env:
        COMMON_PASS: ${{ secrets.COMMON_PASS }}
        ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
      run: |
        echo "Running test suite..."
        mvn -B clean test

    - name: Run OWASP Dependency Check
      if: ${{ !inputs.skip-tests }}
      run: |
        echo "Running OWASP dependency check..."
        mvn -B org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=7
      continue-on-error: true  # Don't fail the release, but report issues

    - name: Upload dependency check report
      if: ${{ !inputs.skip-tests }}
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: ./target/dependency-check-report.*
        if-no-files-found: ignore

    - name: Set release version
      run: |
        echo "Setting version to ${{ inputs.release-version }}"
        mvn versions:set -DnewVersion=${{ inputs.release-version }} -DgenerateBackupPoms=false
        git add pom.xml
        git commit -m "chore: release version ${{ inputs.release-version }}"

    - name: Build and package
      env:
        COMMON_PASS: ${{ secrets.COMMON_PASS }}
        ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
      run: |
        echo "Building release artifacts..."
        mvn -B clean package -DskipTests=${{ inputs.skip-tests }} -DskipDependencyCheck=true

    - name: Deploy to GitHub Packages
      env:
        COMMON_PASS: ${{ secrets.COMMON_PASS }}
      run: |
        echo "Deploying to GitHub Packages..."
        mvn -B deploy -DskipTests -DskipDependencyCheck=true

    - name: Create Git tag
      run: |
        git tag -a "v${{ inputs.release-version }}" -m "Release version ${{ inputs.release-version }}"
        git push origin "v${{ inputs.release-version }}"

    - name: Generate changelog
      id: changelog
      run: |
        echo "Generating changelog from commits..."
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -z "$PREVIOUS_TAG" ]; then
          echo "First release, showing all commits"
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          echo "Generating changelog from $PREVIOUS_TAG to v${{ inputs.release-version }}"
          CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi

        # Save changelog to file for GitHub Release
        cat << EOF > RELEASE_NOTES.md
        # Release ${{ inputs.release-version }}

        ## Changes

        $CHANGELOG

        ## Installation

        Add to your \`pom.xml\`:

        \`\`\`xml
        <dependency>
          <groupId>gov.cdc.izgw</groupId>
          <artifactId>izgw-core</artifactId>
          <version>${{ inputs.release-version }}</version>
        </dependency>
        \`\`\`

        ## Maven Repository

        \`\`\`xml
        <repositories>
          <repository>
            <id>github</id>
            <url>https://maven.pkg.github.com/IZGateway/izgw-core</url>
          </repository>
        </repositories>
        \`\`\`
        EOF

        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat RELEASE_NOTES.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ inputs.release-version }}
        name: IZ Gateway Core v${{ inputs.release-version }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          target/*.jar
          target/*.pom
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Bump to next SNAPSHOT version
      run: |
        echo "Bumping to next SNAPSHOT version: ${{ inputs.next-snapshot-version }}"
        mvn versions:set -DnewVersion=${{ inputs.next-snapshot-version }} -DgenerateBackupPoms=false
        git add pom.xml
        git commit -m "chore: bump version to ${{ inputs.next-snapshot-version }}"
        git push origin ${{ github.ref_name }}

    - name: Summary
      run: |
        echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Released version: **${{ inputs.release-version }}**" >> $GITHUB_STEP_SUMMARY
        echo "✅ Tagged as: **v${{ inputs.release-version }}**" >> $GITHUB_STEP_SUMMARY
        echo "✅ Deployed to GitHub Packages" >> $GITHUB_STEP_SUMMARY
        echo "✅ Created GitHub Release" >> $GITHUB_STEP_SUMMARY
        echo "✅ Bumped to: **${{ inputs.next-snapshot-version }}**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.release-version }})" >> $GITHUB_STEP_SUMMARY
        echo "2. Notify consuming applications of the new release" >> $GITHUB_STEP_SUMMARY
        echo "3. Update documentation if needed" >> $GITHUB_STEP_SUMMARY

    - name: Notify on failure
      if: failure()
      run: |
        echo "## ❌ Release Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The release process failed. Please check the logs above." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Troubleshooting" >> $GITHUB_STEP_SUMMARY
        echo "- Check that all tests pass" >> $GITHUB_STEP_SUMMARY
        echo "- Verify no SNAPSHOT dependencies exist" >> $GITHUB_STEP_SUMMARY
        echo "- Ensure GitHub Packages authentication is configured" >> $GITHUB_STEP_SUMMARY
        echo "- Check that the version numbers are valid" >> $GITHUB_STEP_SUMMARY
