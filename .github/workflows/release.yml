name: Release

on:
  workflow_dispatch:
    inputs:
      release-version:
        description: 'Release version (e.g., 2.4.0-izgw-core)'
        required: true
        type: string
      next-snapshot-version:
        description: 'Next SNAPSHOT version (e.g., 2.5.0-izgw-core-SNAPSHOT)'
        required: true
        type: string
      skip-tests:
        description: 'Skip tests (use only for emergency releases)'
        required: false
        type: boolean
        default: false
      delete-release-branch-on-failure:
        description: 'Delete release branch if workflow fails'
        required: false
        type: boolean
        default: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.ACTIONS_KEY }}
        fetch-depth: 0  # Full history for release notes generation

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'adopt'
        cache: maven
        server-id: github
        server-username: GITHUB_ACTOR
        server-password: GITHUB_TOKEN

    - name: Set up Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.0

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Validate prerequisites
      id: validate
      run: |
        echo "Validating release prerequisites..."

        # Validate version formats
        if [[ ! "${{ inputs.release-version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+\-izgw\-core$ ]]; then
          echo "‚ùå Error: Release version must be in format X.Y.Z-izgw-core (e.g., 2.4.0-izgw-core)"
          exit 1
        fi
        if [[ ! "${{ inputs.next-snapshot-version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+\-izgw\-core\-SNAPSHOT$ ]]; then
          echo "‚ùå Error: Next SNAPSHOT version must be in format X.Y.Z-izgw-core-SNAPSHOT (e.g., 2.5.0-izgw-core-SNAPSHOT)"
          exit 1
        fi
        echo "‚úì Version format validation passed"

        # Validate current branch is develop
        CURRENT_BRANCH="${{ github.ref_name }}"
        if [[ "$CURRENT_BRANCH" != "develop" ]]; then
          echo "‚ùå Error: Release workflow must be run from 'develop' branch"
          echo "Current branch: $CURRENT_BRANCH"
          echo ""
          echo "Please switch to develop branch and try again:"
          echo "  git checkout develop"
          echo "  git pull origin develop"
          exit 1
        fi
        echo "‚úì Running from develop branch"

        # Set release branch name
        RELEASE_BRANCH="release/${{ inputs.release-version }}"
        echo "release_branch=$RELEASE_BRANCH" >> $GITHUB_OUTPUT
        echo "Release branch will be: $RELEASE_BRANCH"

        # Check if release branch already exists
        if git ls-remote --exit-code --heads origin "$RELEASE_BRANCH" >/dev/null 2>&1; then
          echo "‚ùå Error: Release branch '$RELEASE_BRANCH' already exists"
          echo ""
          echo "This likely means a previous release attempt failed or is in progress."
          echo "Please either:"
          echo "  1. Delete the branch: git push origin --delete $RELEASE_BRANCH"
          echo "  2. Or use a different version number"
          exit 1
        fi
        echo "‚úì Release branch does not exist yet"

        # Check if tag already exists
        if git ls-remote --exit-code --tags origin "v${{ inputs.release-version }}" >/dev/null 2>&1; then
          echo "‚ùå Error: Tag 'v${{ inputs.release-version }}' already exists"
          echo "This version has already been released. Please use a different version number."
          exit 1
        fi
        echo "‚úì Release tag does not exist yet"

    - name: Check for SNAPSHOT dependencies
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Checking for SNAPSHOT dependencies..."
        # Get all SNAPSHOT dependencies except izgw-bom (parent) and the project itself
        SNAPSHOT_DEPS=$(mvn dependency:tree -Dincludes=*:*:*:*:*-SNAPSHOT -DexcludeGroupIds=gov.cdc.izgw -DoutputType=text | grep SNAPSHOT | grep -v "izgw-core" || true)

        if [ -n "$SNAPSHOT_DEPS" ]; then
          echo "‚ùå ERROR: Found SNAPSHOT dependencies in the project:"
          echo "$SNAPSHOT_DEPS"
          echo ""
          echo "Please update all dependencies to release versions before creating a release."
          exit 1
        else
          echo "‚úì No SNAPSHOT dependencies found (parent BOM and project itself excluded)"
        fi

    - name: Check if artifact already exists in GitHub Packages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Checking if artifact already exists in GitHub Packages..."

        # Extract version without -izgw-core suffix for artifact path
        VERSION_NUM=$(echo "${{ inputs.release-version }}" | sed 's/-izgw-core$//')

        # Try to check if the package version exists using GitHub API
        # Note: This checks for the package version, not individual artifacts
        PACKAGE_EXISTS=$(gh api \
          -H "Accept: application/vnd.github+json" \
          "/orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions" \
          --jq ".[] | select(.name==\"$VERSION_NUM\") | .name" 2>/dev/null || echo "")

        if [ -n "$PACKAGE_EXISTS" ]; then
          echo "‚ùå ERROR: Artifact version $VERSION_NUM already exists in GitHub Packages"
          echo ""
          echo "This likely means a previous release attempt failed after deploying artifacts."
          echo ""
          echo "To clean up and retry the release:"
          echo ""
          echo "1. Delete the package version from GitHub Packages:"
          echo "   ‚Ä¢ Via GitHub CLI:"
          echo "     VERSION_ID=\$(gh api /orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions --jq '.[] | select(.name==\"$VERSION_NUM\") | .id')"
          echo "     gh api --method DELETE /orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions/\$VERSION_ID"
          echo ""
          echo "   ‚Ä¢ Via GitHub UI:"
          echo "     https://github.com/orgs/IZGateway/packages?repo_name=izgw-core"
          echo "     ‚Üí Select 'izgw-core' package ‚Üí Find version $VERSION_NUM ‚Üí Delete"
          echo ""
          echo "2. Delete the release branch if it was created:"
          echo "   git push origin --delete release/${{ inputs.release-version }}"
          echo ""
          echo "3. Delete the git tag if it was created:"
          echo "   git push origin --delete v${{ inputs.release-version }}"
          echo ""
          echo "4. If merge to main happened, you may need to revert the merge commit on main"
          echo ""
          echo "5. After cleanup, re-run this workflow"
          exit 1
        fi

        echo "‚úì Artifact does not exist in GitHub Packages yet"

    - name: Create release branch
      run: |
        echo "Creating release branch: ${{ steps.validate.outputs.release_branch }}"
        git checkout -b "${{ steps.validate.outputs.release_branch }}"
        git push origin "${{ steps.validate.outputs.release_branch }}"
        echo "‚úì Release branch created and pushed"

    - name: Update RELEASE_NOTES.md
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Generating release note entries from merged PRs..."

        # Get the previous tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD 2>/dev/null || echo "")

        if [ -z "$PREVIOUS_TAG" ]; then
          echo "First release, getting all merge commits"
          # Get all merge commits
          PR_CHANGES=$(git log --merges --oneline | grep "pull request" | sed -E 's/.*#([0-9]+).*/\1/' | xargs -I {} gh pr view {} --json number,title,url --jq '"- \(.title) ([#\(.number)](\(.url)))"')
        else
          echo "Generating release note from $PREVIOUS_TAG to HEAD"
          # Get merge commits since the previous tag
          PR_CHANGES=$(git log ${PREVIOUS_TAG}..HEAD --merges --oneline | grep "pull request" | sed -E 's/.*#([0-9]+).*/\1/' | xargs -I {} gh pr view {} --json number,title,url --jq '"- \(.title) ([#\(.number)](\(.url)))"')
        fi

        # Check if we found any PRs
        if [ -z "$PR_CHANGES" ]; then
          echo "‚ö†Ô∏è  No merged PRs found. Using commit messages as fallback."
          if [ -z "$PREVIOUS_TAG" ]; then
            PR_CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            PR_CHANGES=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
        fi

        # Get current date
        RELEASE_DATE=$(date +%Y-%m-%d)

        # Create new release note entry
        cat > RELEASE_NOTES_ENTRY.md << EOF
        ## [${{ inputs.release-version }}] - $RELEASE_DATE

        ### Changes
        $PR_CHANGES

        EOF

        # Check if RELEASE_NOTES.md exists
        if [ -f "RELEASE_NOTES.md" ]; then
          # Prepend new entry to existing RELEASE_NOTES.md
          cat RELEASE_NOTES.md >> RELEASE_NOTES_ENTRY.md
          mv RELEASE_NOTES_ENTRY.md RELEASE_NOTES.md
        else
          # Create new RELEASE_NOTES.md
          cat > RELEASE_NOTES.md << EOF
        # Release Notes

        All notable changes to this project will be documented in this file.

        The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
        and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

        EOF
          cat RELEASE_NOTES_ENTRY.md >> RELEASE_NOTES.md
          rm RELEASE_NOTES_ENTRY.md
        fi

        git add RELEASE_NOTES.md
        git commit -m "docs: update RELEASE_NOTES.md for release ${{ inputs.release-version }}"
        echo "‚úì RELEASE_NOTES.md updated"

    - name: Set release version
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Setting version to ${{ inputs.release-version }}"
        mvn versions:set -DnewVersion=${{ inputs.release-version }} -DgenerateBackupPoms=false
        git add pom.xml
        git commit -m "chore: prepare release ${{ inputs.release-version }}"
        git push origin "${{ steps.validate.outputs.release_branch }}"
        echo "‚úì Release version set and committed"

    - name: Run tests
      if: ${{ !inputs.skip-tests }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COMMON_PASS: ${{ secrets.COMMON_PASS }}
        ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
      run: |
        echo "Running test suite..."
        mvn -B clean test

    - name: Run OWASP Dependency Check
      if: ${{ !inputs.skip-tests }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Running OWASP dependency check..."
        mvn -B org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=7

    - name: Upload dependency check report
      if: ${{ !inputs.skip-tests }}
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: ./target/dependency-check-report.*
        if-no-files-found: ignore

    - name: Build and package
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COMMON_PASS: ${{ secrets.COMMON_PASS }}
        ELASTIC_API_KEY: ${{ secrets.ELASTIC_API_KEY }}
      run: |
        echo "Building release artifacts..."
        mvn -B clean package -DskipTests=${{ inputs.skip-tests }} -DskipDependencyCheck=true

    - name: Merge release branch to main
      run: |
        echo "Merging release branch to main..."

        # Check if main branch exists
        if git ls-remote --exit-code --heads origin main >/dev/null 2>&1; then
          echo "Main branch exists, fetching..."
          git fetch origin main
          git checkout main
          # Use -X theirs to prefer release branch version for conflicts (e.g., RELEASE_NOTES.md)
          # During a release, the release branch has the authoritative version of release documentation
          git merge --no-ff -X theirs "${{ steps.validate.outputs.release_branch }}" -m "Merge release branch ${{ steps.validate.outputs.release_branch }}"
        else
          echo "Main branch does not exist (first release), creating from release branch..."
          git checkout -b main
        fi

        git push origin main
        echo "‚úì Release branch merged to main"

    - name: Create Git tag on main
      run: |
        echo "Creating tag v${{ inputs.release-version }} on main branch..."
        git tag -a "v${{ inputs.release-version }}" -m "Release version ${{ inputs.release-version }}"
        git push origin "v${{ inputs.release-version }}"
        echo "‚úì Tag created on main"

    - name: Deploy to GitHub Packages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COMMON_PASS: ${{ secrets.COMMON_PASS }}
      run: |
        echo "Deploying to GitHub Packages..."
        echo "Git operations completed successfully - proceeding with artifact deployment"
        mvn -B deploy -DskipTests -DskipDependencyCheck=true
        echo "‚úì Artifacts deployed to GitHub Packages"

    - name: Generate GitHub Release notes
      id: release-notes
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Generating release notes from merged PRs..."
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 "v${{ inputs.release-version }}"^ 2>/dev/null || echo "")

        if [ -z "$PREVIOUS_TAG" ]; then
          echo "First release, getting all merge commits"
          PR_CHANGES=$(git log --merges --oneline "v${{ inputs.release-version }}" | grep "pull request" | sed -E 's/.*#([0-9]+).*/\1/' | xargs -I {} gh pr view {} --json number,title,url --jq '"- \(.title) ([#\(.number)](\(.url)))"')
        else
          echo "Generating release notes from $PREVIOUS_TAG to v${{ inputs.release-version }}"
          PR_CHANGES=$(git log ${PREVIOUS_TAG}..v${{ inputs.release-version }} --merges --oneline | grep "pull request" | sed -E 's/.*#([0-9]+).*/\1/' | xargs -I {} gh pr view {} --json number,title,url --jq '"- \(.title) ([#\(.number)](\(.url)))"')
        fi

        # Fallback to commits if no PRs found
        if [ -z "$PR_CHANGES" ]; then
          echo "‚ö†Ô∏è  No merged PRs found. Using commit messages as fallback."
          if [ -z "$PREVIOUS_TAG" ]; then
            PR_CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges "v${{ inputs.release-version }}")
          else
            PR_CHANGES=$(git log ${PREVIOUS_TAG}..v${{ inputs.release-version }} --pretty=format:"- %s (%h)" --no-merges)
          fi
        fi

        # Save release notes to file for GitHub Release
        cat << EOF > RELEASE_NOTES.md
        # Release ${{ inputs.release-version }}

        ## Changes

        $PR_CHANGES

        ## Installation

        Add to your \`pom.xml\`:

        \`\`\`xml
        <dependency>
          <groupId>gov.cdc.izgw</groupId>
          <artifactId>izgw-core</artifactId>
          <version>${{ inputs.release-version }}</version>
        </dependency>
        \`\`\`

        ## Maven Repository

        \`\`\`xml
        <repositories>
          <repository>
            <id>github</id>
            <url>https://maven.pkg.github.com/IZGateway/izgw-core</url>
          </repository>
        </repositories>
        \`\`\`
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ inputs.release-version }}
        name: IZ Gateway Core v${{ inputs.release-version }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          target/*.jar
          target/*.pom
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update develop branch
      run: |
        echo "Updating develop branch..."

        # Checkout develop
        git checkout develop
        git pull origin develop

        # Merge release branch to get RELEASE_NOTES.md updates
        echo "Merging release branch to develop for RELEASE_NOTES updates..."
        git merge --no-ff "${{ steps.validate.outputs.release_branch }}" -m "Merge release branch ${{ steps.validate.outputs.release_branch }} to develop"

        # Bump to next SNAPSHOT version
        echo "Bumping to next SNAPSHOT version: ${{ inputs.next-snapshot-version }}"
        mvn versions:set -DnewVersion=${{ inputs.next-snapshot-version }} -DgenerateBackupPoms=false
        git add pom.xml
        git commit -m "chore: bump version to ${{ inputs.next-snapshot-version }}"

        # Push develop
        git push origin develop
        echo "‚úì Develop branch updated with RELEASE_NOTES and next SNAPSHOT version"

    - name: Summary
      run: |
        echo "## ‚úÖ Release Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Release Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Release version:** ${{ inputs.release-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release branch:** ${{ steps.validate.outputs.release_branch }} (kept)" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag:** v${{ inputs.release-version }} (on main)" >> $GITHUB_STEP_SUMMARY
        echo "- **Next version:** ${{ inputs.next-snapshot-version }} (on develop)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### What Happened" >> $GITHUB_STEP_SUMMARY
        echo "1. ‚úÖ Created release branch from develop" >> $GITHUB_STEP_SUMMARY
        echo "2. ‚úÖ Updated RELEASE_NOTES.md with release notes" >> $GITHUB_STEP_SUMMARY
        echo "3. ‚úÖ Set version to ${{ inputs.release-version }}" >> $GITHUB_STEP_SUMMARY
        echo "4. ‚úÖ Ran tests and security checks" >> $GITHUB_STEP_SUMMARY
        echo "5. ‚úÖ Built release artifacts" >> $GITHUB_STEP_SUMMARY
        echo "6. ‚úÖ Merged release branch to main (auto-resolving conflicts)" >> $GITHUB_STEP_SUMMARY
        echo "7. ‚úÖ Tagged v${{ inputs.release-version }} on main" >> $GITHUB_STEP_SUMMARY
        echo "8. ‚úÖ Deployed artifacts to GitHub Packages" >> $GITHUB_STEP_SUMMARY
        echo "9. ‚úÖ Created GitHub Release" >> $GITHUB_STEP_SUMMARY
        echo "10. ‚úÖ Updated develop with RELEASE_NOTES and bumped to ${{ inputs.next-snapshot-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. üì¶ Review the [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.release-version }})" >> $GITHUB_STEP_SUMMARY
        echo "2. üì¢ **Notify consuming applications (izg-hub, izg-xform) of the new release**" >> $GITHUB_STEP_SUMMARY
        echo "3. üìã Review RELEASE_NOTES.md in develop branch" >> $GITHUB_STEP_SUMMARY
        echo "4. üìö Update integration documentation if needed" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup on failure
      if: failure() && inputs.delete-release-branch-on-failure
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Cleaning up failed release..."

        # Delete git tag if it exists
        if git ls-remote --exit-code --tags origin "v${{ inputs.release-version }}" >/dev/null 2>&1; then
          echo "Deleting git tag: v${{ inputs.release-version }}"
          git push origin --delete "v${{ inputs.release-version }}" || true
        fi

        # Delete release branch if it exists
        if git ls-remote --exit-code --heads origin "${{ steps.validate.outputs.release_branch }}" >/dev/null 2>&1; then
          echo "Deleting release branch: ${{ steps.validate.outputs.release_branch }}"
          git push origin --delete "${{ steps.validate.outputs.release_branch }}" || true
        fi

        # Try to delete artifact from GitHub Packages if it was deployed
        VERSION_NUM=$(echo "${{ inputs.release-version }}" | sed 's/-izgw-core$//')
        VERSION_ID=$(gh api \
          -H "Accept: application/vnd.github+json" \
          "/orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions" \
          --jq ".[] | select(.name==\"$VERSION_NUM\") | .id" 2>/dev/null || echo "")

        if [ -n "$VERSION_ID" ]; then
          echo "Deleting artifact from GitHub Packages (version ID: $VERSION_ID)..."
          gh api --method DELETE "/orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions/$VERSION_ID" || true
        fi

        echo "## ‚ùå Release Failed - Cleaned Up" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The release process failed. Cleaned up:" >> $GITHUB_STEP_SUMMARY
        echo "- Release branch (if created)" >> $GITHUB_STEP_SUMMARY
        echo "- Git tag (if created)" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub Packages artifact (if deployed)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Troubleshooting" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the error logs above" >> $GITHUB_STEP_SUMMARY
        echo "2. Fix issues on develop branch" >> $GITHUB_STEP_SUMMARY
        echo "3. Run the workflow again" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Common Issues" >> $GITHUB_STEP_SUMMARY
        echo "- Tests failing: Fix tests on develop and re-run" >> $GITHUB_STEP_SUMMARY
        echo "- SNAPSHOT dependencies: Update dependencies to release versions" >> $GITHUB_STEP_SUMMARY
        echo "- Authentication issues: Verify GitHub Packages credentials" >> $GITHUB_STEP_SUMMARY
        echo "- Branch/tag conflicts: Check if release already exists" >> $GITHUB_STEP_SUMMARY

    - name: Notify on failure (keep branch)
      if: failure() && !inputs.delete-release-branch-on-failure
      run: |
        echo "## ‚ùå Release Failed - Branch Kept" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The release process failed. The release branch **${{ steps.validate.outputs.release_branch }}** has been kept for investigation." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Manual Cleanup Required" >> $GITHUB_STEP_SUMMARY
        echo "You may need to clean up the following (check if they exist):" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **Git tag** (if created):" >> $GITHUB_STEP_SUMMARY
        echo "   \`git push origin --delete v${{ inputs.release-version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "2. **Release branch** (when ready):" >> $GITHUB_STEP_SUMMARY
        echo "   \`git push origin --delete ${{ steps.validate.outputs.release_branch }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "3. **GitHub Packages artifact** (if deployed):" >> $GITHUB_STEP_SUMMARY
        echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "   VERSION_ID=\\\$(gh api /orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions --jq '.[] | select(.name==\"$(echo "${{ inputs.release-version }}" | sed 's/-izgw-core$//')\") | .id')" >> $GITHUB_STEP_SUMMARY
        echo "   gh api --method DELETE /orgs/IZGateway/packages/maven/gov.cdc.izgw.izgw-core/versions/\\\$VERSION_ID" >> $GITHUB_STEP_SUMMARY
        echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the error logs above" >> $GITHUB_STEP_SUMMARY
        echo "2. Investigate the release branch manually if needed" >> $GITHUB_STEP_SUMMARY
        echo "3. Clean up artifacts using commands above" >> $GITHUB_STEP_SUMMARY
        echo "4. Fix issues on develop branch" >> $GITHUB_STEP_SUMMARY
        echo "5. Run the workflow again" >> $GITHUB_STEP_SUMMARY
